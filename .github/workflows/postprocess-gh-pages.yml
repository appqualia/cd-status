name: Postprocess gh-pages (fix absolute icon paths)

on:
  workflow_run:
    workflows: ["Static Site CI"]
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  fix:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Patch icon paths (force /cd-status/*) and manifest start_url
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import pathlib, re

          BASE = "/cd-status"
          changed = []

          def patch_text(s: str) -> str:
              # 1) Fix favicon links to always include BASE
              #    href=/logo-192.png  -> href=/cd-status/logo-192.png
              #    href=logo-192.png   -> href=/cd-status/logo-192.png
              s = re.sub(r'(\bhref=)/logo-(\d+\.png)\b', rf'\1{BASE}/logo-\2', s)
              s = re.sub(r'(\bhref=)logo-(\d+\.png)\b',  rf'\1{BASE}/logo-\2', s)

              # 2) Fix any src="/logo-*.png" patterns too (rare, but safe)
              s = re.sub(r'(\bsrc=["\'])/logo-(\d+\.png)\b', rf'\1{BASE}/logo-\2', s)

              return s

          # Patch all HTML files in gh-pages
          for p in pathlib.Path(".").rglob("*.html"):
              s = p.read_text(encoding="utf-8", errors="ignore")
              s2 = patch_text(s)
              if s2 != s:
                  p.write_text(s2, encoding="utf-8")
                  changed.append(str(p))

          # Patch manifest.json: set start_url to BASE (and keep icons as-is)
          m = pathlib.Path("manifest.json")
          if m.exists():
              s = m.read_text(encoding="utf-8", errors="ignore")
              # start_url: "/" -> "/cd-status/"
              s2 = re.sub(r'"start_url"\s*:\s*"\s*/\s*"', f'"start_url": "{BASE}/"', s)
              if s2 != s:
                  m.write_text(s2, encoding="utf-8")
                  changed.append(str(m))

          if changed:
              print("Patched:", ", ".join(changed))
          else:
              print("No files needed patching.")
          PY

      - name: Commit & push if changed
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Fix absolute /logo-* paths for GitHub Pages baseUrl"
          git push origin gh-pages
